# @jridgewell/trace-mapping

> Trace the original position through a source map

`trace-mapping` allows you to take the line and column of an output file and trace it to the
original location in the source file through a source map.

You may already be familiar with the [`source-map`][source-map] package's `SourceMapConsumer`. This
provides the same `originalPositionFor` and `generatedPositionFor` API, without requiring WASM.

## Installation

```sh
npm install @jridgewell/trace-mapping
```

## Usage

```typescript
import {
  TraceMap,
  originalPositionFor,
  generatedPositionFor,
  sourceContentFor,
  isIgnored,
} from '@jridgewell/trace-mapping';

const tracer = new TraceMap({
  version: 3,
  sources: ['input.js'],
  sourcesContent: ['content of input.js'],
  names: ['foo'],
  mappings: 'KAyCIA',
  ignoreList: [],
});

// Lines start at line 1, columns at column 0.
const traced = originalPositionFor(tracer, { line: 1, column: 5 });
assert.deepEqual(traced, {
  source: 'input.js',
  line: 42,
  column: 4,
  name: 'foo',
});

const content = sourceContentFor(tracer, traced.source);
assert.strictEqual(content, 'content for input.js');

const generated = generatedPositionFor(tracer, {
  source: 'input.js',
  line: 42,
  column: 4,
});
assert.deepEqual(generated, {
  line: 1,
  column: 5,
});

const ignored = isIgnored(tracer, 'input.js');
assert.equal(ignored, false);
```

We also provide a lower level API to get the actual segment that matches our line and column. Unlike
`originalPositionFor`, `traceSegment` uses a 0-base for `line`:

```typescript
import { traceSegment } from '@jridgewell/trace-mapping';

// line is 0-base.
const traced = traceSegment(tracer, /* line */ 0, /* column */ 5);

// Segments are [outputColumn, sourcesIndex, sourceLine, sourceColumn, namesIndex]
// Again, line is 0-base and so is sourceLine
assert.deepEqual(traced, [5, 0, 41, 4, 0]);
```

### SectionedSourceMaps

The sourcemap spec defines a special `sections` field that's designed to handle concatenation of
output code with associated sourcemaps. This type of sourcemap is rarely used (no major build tool
produces it), but if you are hand coding a concatenation you may need it. We provide an `AnyMap`
helper that can receive either a regular sourcemap or a `SectionedSourceMap` and returns a
`TraceMap` instance:

```typescript
import { AnyMap } from '@jridgewell/trace-mapping';
const fooOutput = 'foo';
const barOutput = 'bar';
const output = [fooOutput, barOutput].join('\n');

const sectioned = new AnyMap({
  version: 3,
  sections: [
    {
      // 0-base line and column
      offset: { line: 0, column: 0 },
      // fooOutput's sourcemap
      map: {
        version: 3,
        sources: ['foo.js'],
        names: ['foo'],
        mappings: 'AAAAA',
      },
    },
    {
      // barOutput's sourcemap will not affect the first line, only the second
      offset: { line: 1, column: 0 },
      map: {
        version: 3,
        sources: ['bar.js'],
        names: ['bar'],
        mappings: 'AAAAA',
      },
    },
  ],
});

const traced = originalPositionFor(sectioned, {
  line: 2,
  column: 0,
});

assert.deepEqual(traced, {
  source: 'bar.js',
  line: 1,
  column: 0,
  name: 'bar',
});
```

## Benchmarks

```
node v18.0.0

amp.js.map - 45120 segments

Memory Usage:
trace-mapping decoded         562400 bytes
trace-mapping encoded        5706544 bytes
source-map-js               10717664 bytes
source-map-0.6.1            17446384 bytes
source-map-0.8.0             9701757 bytes
Smallest memory usage is trace-mapping decoded

Init speed:
trace-mapping:    decoded JSON input x 180 ops/sec ±0.34% (85 runs sampled)
trace-mapping:    encoded JSON input x 364 ops/sec ±1.77% (89 runs sampled)
trace-mapping:    decoded Object input x 3,116 ops/sec ±0.50% (96 runs sampled)
trace-mapping:    encoded Object input x 410 ops/sec ±2.62% (85 runs sampled)
source-map-js:    encoded Object input x 84.23 ops/sec ±0.91% (73 runs sampled)
source-map-0.6.1: encoded Object input x 37.21 ops/sec ±2.08% (51 runs sampled)
Fastest is trace-mapping:    decoded Object — Microsoft EdgeMicrosoft Edge Интернетта тизрәк һәм иминрәк карау тәҗрибәсен тәкъдим итә. Microsoft Edge’дан чыкмыйча иске төеннәрне ачу өчен кораллар аслыгындагы Internet Explorer режимын кулланып карагыз.Internet Explorer (IE) искерде һәм бүтән кулланылмый. Сез Internet Explorer’ны куллануны дәвам итәргә телисезме?Әйе, раслыймMicrosoft Edge белән искергән төеннәрне эшләтүИскергән төеннәрне ачканда проблемага юлыгасызмы? Internet Explorer режимында искергән төеннәрне Microsoft Edge белән ачып була. Искергән төеннәрне Internet Explorer режимында автоматик рәвештә ачу максаты белән искергән төенне төеннәр исемлегенә өстәү өчен, сайлагыз $1 under $2.Искергән төеннәрне ачканда проблемаларга юлыктыгызмы? Internet Explorer режимы белән Microsoft Edge'да искергән төеннәрне ача аласыз. Төеннәр исемлегенә теләсә-нинди искергән төенне өстәү өчен,  Internet Explorer режимы сәхифәсендә “Өстәү” дигән юнәлешне сайлагыз. Алар автоматик рәвештә Internet Explorer режимында ачылачак.Internet Explorer кирәк булган төеннәрне һәрвакыт Microsoft Edge’да ачыгызБу үзлек кабызылган булганда, ярашлылык өчен IE кирәк булган кушымталардан сылтамаларны ачу өчен, без автоматик рәвештә Microsoft Edge’ны ачабыз.Бу параметрны кабызу өчен, безгә Microsoft Edge’ны сүндереп кабызырга кирәкПринтерларПринтерлар белән идарә итүУрын үзгәртүҺәр йөкләү белән нәрсә эшләргә икәнен миннән сорауФайлны саклау яки сакламыйча ачу алдыннан Һәрвакыт миннән сорауOffice файлларын күзәтүчедә ачуБу параметр кабызылган булса, Office файллары (презентацияләр, электрон таблицалар, документлар) Microsoft Edge’да автомат рәвешендә ачылачак, җайланмагызга йөкләнү урынынаЙөкләү башланганда йөкләүләр сайлагын күрсәтүБу параметрны сүндерү файлның кайчан йөкләнә башлавын белүне кыенлаштырырга мөмкинОешмагыз билгеләгән йөкләүдән соң автомат рәвештә ачу өчен файл төрләреОешмагыз билгеле доменнардан кайбер файл төрләренең һәрвакыт автомат рәвештә ачылуын таләп итәБер файл тибы да автоматик рәвештә ачу өчен көйләнмәгәнБарысын да чистартуЙөкләү төймәсен кораллар аслыгында һәрвакыт күрсәтүБу параметрны өзсәгез, төймә кораллар аслыгында бары тик йөкләү вакытында күрсәтеләчәкБашлангыч бит, өй һәм яңа салынмаларMicrosoft Edge эшләп киткәндәЯңа салынма битен ачуАлдагы сеанстан ачык салынмаларБу битләрне ачу:Барлык ачык салынмаларны ачыласы битләр исемлеге буларак куллануБарлык хәзерге вакытта ачык салынмаларга билгеләүБулган битләр исемлеген чистарта һәм хәзерге вакытта ачылган барлык Edge салынмалары белән алмаштыраИсемлекне чистарту һәм анда хәзерге вакытта ачылган барлык салынмаларны билгеләүБитләр$1 эшләтеп җибәрү бите яңартылдыХәзерге вакытта барлык ачык салынмалар куллануга көйләнгәнMicrosoft Edge башлау бите параметрларын тышкы кушымта я