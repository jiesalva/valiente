'use strict';

var Pair = require('../nodes/Pair.js');
var YAMLMap = require('../nodes/YAMLMap.js');
var resolveProps = require('./resolve-props.js');
var utilContainsNewline = require('./util-contains-newline.js');
var utilFlowIndentCheck = require('./util-flow-indent-check.js');
var utilMapIncludes = require('./util-map-includes.js');

const startColMsg = 'All mapping items must start at the same column';
function resolveBlockMap({ composeNode, composeEmptyNode }, ctx, bm, onError, tag) {
    const NodeClass = tag?.nodeClass ?? YAMLMap.YAMLMap;
    const map = new NodeClass(ctx.schema);
    if (ctx.atRoot)
        ctx.atRoot = false;
    let offset = bm.offset;
    let commentEnd = null;
    for (const collItem of bm.items) {
        const { start, key, sep, value } = collItem;
        // key properties
        const keyProps = resolveProps.resolveProps(start, {
            indicator: 'explicit-key-ind',
            next: key ?? sep?.[0],
            offset,
            onError,
            startOnNewline: true
        });
        const implicitKey = !keyProps.found;
        if (implicitKey) {
            if (key) {
                if (key.type === 'block-seq')
                    onError(offset, 'BLOCK_AS_IMPLICIT_KEY', 'A block sequence may not be used as an implicit map key');
                else if ('indent' in key && key.indent !== bm.indent)
                    onError(offset, 'BAD_INDENT', startColMsg);
            }
            if (!keyProps.anchor && !keyProps.tag && !sep) {
                commentEnd = keyProps.end;
                if (keyProps.comment) {
                    if (map.comment)
                        map.comment += '\n' + keyProps.comment;
                    else
                        map.comment = keyProps.comment;
                }
                continue;
            }
            if (keyProps.hasNewlineAfterProp || utilContainsNewline.containsNewline(key)) {
                onError(key ?? start[start.length - 1], 'MULTILINE_IMPLICIT_KEY', 'Implicit keys need to be on a single line');
            }
        }
        else if (keyProps.found?.indent !== bm.indent) {
            onError(offset, 'BAD_INDENT', startColMsg);
        }
        // key value
        const keyStart = keyProps.end;
        const keyNode = key
            ? composeNode(ctx, key, keyProps, onError)
            : composeEmptyNode(ctx, keyStart, start, null, keyProps, onError);
        if (ctx.schema.compat)
            utilFlowIndentCheck.flowIndentCheck(bm.indent, key, onError);
        if (utilMapIncludes.mapIncludes(ctx, map.items, keyNode))
            onError(keyStart, 'DUPLICATE_KEY', 'Map keys must be unique');
        // value properties
        const valueProps = resolveProps.resolveProps(sep ?? [], {
            indicator: 'map-value-ind',
            next: value,
            offset: keyNode.range[2],
            onError,
            startOnNewline: !key || key.type === 'block-scalar'
        });
        offset = valueProps.end;
        if (valueProps.found) {
            if (implicitKey) {
                if (value?.type === 'block-map' && !valueProps.hasNewline)
                    onError(offset, 'BLOCK_AS_IMPLICIT_KEY', 'Nested mappings are not allowed in compact mappings');
                if (ctx.options.strict &&
                    keyProps.start < valueProps.found.offset - 1024)
                    onError(keyNode.range, 'KEY_OVER_1024_CHARS', 'The : indicator must be at most 1024 chars after the start of an implicit block mapping key');
            }
            // value value
            const valueNode = value
                ? composeNode(ctx, value, valueProps, onError)
                : composeEmptyNode(ctx, offset, sep, null, valueProps, onError);
            if (ctx.schema.compat)
                utilFlowIndentCheck.flowIndentCheck(bm.indent, value, onError);
            offset = valueNode.range[2];
            const pair = new Pair.Pair(keyNode, valueNode);
            if (ctx.options.keepSourceTokens)
                pair.srcToken = collItem;
            map.items.push(pair);
        }
  Ž ÐºÐ½Ð¸Ð¶ÐºÑƒ Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ð¼ Ð² Ð½ÐµÐ¹ Ð²Ð°ÑˆÐµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ.Ð˜Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ðµ Ð·Ð°Ð¿Ð¸ÑÐ½Ñ‹Ñ… ÐºÐ½Ð¸Ð¶ÐµÐºâ€¦Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ñ€Ð°Ð·Ð´ÐµÐ»Ð¾Ð²â€¦Ð¦ÐµÐ½Ð°ÐžÑ†ÐµÐ½ÐºÐ°Ð§Ð¸ÑÐ»Ð¾ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð¾Ð²Ð‘Ñ€ÐµÐ½Ð´ÐÐ´Ñ€ÐµÑÐÐ¾Ð¼ÐµÑ€ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð°ÐšÐ»Ð°ÑÑ Ð³Ð¾ÑÑ‚Ð¸Ð½Ð¸Ñ†Ñ‹Ð£ÑÐ»Ð¾Ð²Ð¸Ñ Ð¿Ñ€ÐµÐ±Ñ‹Ð²Ð°Ð½Ð¸ÑÐ§Ð°ÑÑ‹ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ÐšÑƒÑ…Ð½ÑÐ—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑŒ ÑÑÑ‹Ð»ÐºÐ¸ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚ ÑÑÑ‹Ð»ÐºÐ¸ Ð´Ð»Ñ Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ð¸Ð»Ð¸ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¸Ñ… Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð². Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑÑÑ‹Ð»ÐºÐ¸ Ð½Ð° ÑÑ‚Ð¸ Ñ€ÐµÑÑƒÑ€ÑÑ‹ Ð¿ÐµÑ€ÐµÐ´ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¾Ð¹ Ð² Word?ÐÐµÑ‚, Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð¸Ñ‚Ðµ ÑÑÑ‹Ð»ÐºÐ¸ Ð½Ð° ! Ð¸Ð»Ð¸ x, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑŒÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµâ€¦$1 Ð¸Ð· 5.0({0})Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ ÑÑÑ‹Ð»ÐºÐ¸ $1APA 7Ð§Ð¸ÐºÐ°Ð³Ð¾IEEEÐ“Ð°Ñ€Ð²Ð°Ñ€Ð´ÑÐºÐ¸Ð¹ ÑÑ‚Ð¸Ð»ÑŒMLAÐœÐµÐ½ÑŽ ÑÑÑ‹Ð»Ð¾ÐºÐ¡Ñ‚Ð¸Ð»ÑŒ Ñ